# ============================================================================
# Docker Compose Configuration: Production Deployment with GHCR Image
# ============================================================================
# This configuration is designed for production environments using pre-built
# Docker images from GitHub Container Registry (GHCR) with automatic updates
# via Watchtower.
#
# Key Features:
# - Uses pre-built image from ghcr.io/qsor27/futurestradinglog:latest
# - Includes Watchtower for automatic image updates from GHCR
# - Does NOT include a Redis container (use external Redis)
# - REDIS_URL should be configured in .env to point to production Redis
#
# Image Pull and Update Strategy:
# - Pulls latest image from GHCR on first deployment
# - Watchtower checks for new images every 5 minutes
# - Automatically updates containers when new images are published
# - Rolling restart ensures zero downtime during updates
# - Old images are automatically cleaned up to save disk space
#
# Redis Strategy for Production:
# - Use a dedicated Redis instance (managed service or separate container)
# - Configure REDIS_URL in .env to point to your production Redis
# - Example: REDIS_URL=redis://your-redis-host:6379/0
# - Ensure Redis is accessible from the Docker container network
# - Never use 'localhost' - use actual hostname or IP address
#
# Important: .env file configuration
# - Set FLASK_SECRET_KEY to a secure random value for production
# - Configure REDIS_URL to point to your production Redis instance
# - Set CACHE_ENABLED=true (required for OHLC data synchronization)
# - Ensure DATA_DIR points to persistent storage location
#
# Troubleshooting Redis Connectivity:
# - Use Redis hostname or IP address, not 'localhost'
# - Verify network connectivity between containers and Redis
# - Test Redis connection: docker exec futurestradinglog redis-cli -h <host> ping
# - .env file values take precedence over docker-compose defaults
# ============================================================================

version: '3.8'

services:
  # Main Application Container
  app:
    # Pre-built image from GitHub Container Registry
    # Watchtower will automatically pull updates from this registry
    image: ghcr.io/qsor27/futurestradinglog:latest
    container_name: futurestradinglog
    ports:
      - "5000:5000"
    volumes:
      # Mount data directory for persistence
      - ./data:/app/data
      # Optional: Mount logs for easier access
      - ./data/logs:/app/data/logs
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=0
      - DATA_DIR=/app/data
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5000
      # Generate a secure secret key for production
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-please-change-this-secret-key}
      # Redis URL should point to production Redis instance
      # Configure in .env with actual hostname/IP of your Redis server
      # Never use 'localhost' - use actual hostname or IP
      - REDIS_URL=${REDIS_URL:-redis://localhost:6379/0}
      # Cache should be enabled for production OHLC synchronization
      - CACHE_ENABLED=${CACHE_ENABLED:-true}
      - CACHE_TTL_DAYS=${CACHE_TTL_DAYS:-14}
      # Auto-import settings
      - AUTO_IMPORT_ENABLED=${AUTO_IMPORT_ENABLED:-true}
      - AUTO_IMPORT_INTERVAL=${AUTO_IMPORT_INTERVAL:-300}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    labels:
      # Watchtower labels for automatic updates
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.monitor-only=false"

  # Watchtower for Automatic Container Updates
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/localtime:/etc/localtime:ro
    environment:
      # Check for updates every 5 minutes (300 seconds)
      - WATCHTOWER_POLL_INTERVAL=300
      # Only monitor containers with the enable label
      - WATCHTOWER_LABEL_ENABLE=true
      # Clean up old images after updating to save disk space
      - WATCHTOWER_CLEANUP=true
      # Include stopped containers in updates
      - WATCHTOWER_INCLUDE_STOPPED=true
      # Restart containers if they stop unexpectedly
      - WATCHTOWER_REVIVE_STOPPED=true
      # Set to true for debugging if needed
      - WATCHTOWER_DEBUG=false
      # Notification level
      - WATCHTOWER_NOTIFICATIONS_LEVEL=info
      # Rolling restart (safer for production)
      - WATCHTOWER_ROLLING_RESTART=true
      # Watchtower will check GitHub Container Registry for updates
      - WATCHTOWER_NO_STARTUP_MESSAGE=false
    restart: unless-stopped
    depends_on:
      - app
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"
