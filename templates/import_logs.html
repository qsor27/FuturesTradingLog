{% extends "base.html" %}

{% block title %}Import Logs{% endblock %}

{% block extra_head %}
<style>
    /* Import logs specific styling */
    .page-header {
        background-color: var(--section-bg);
        color: var(--text-color);
        border-bottom: 1px solid var(--border-color);
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .filters-section {
        background-color: #2a2a2a;
        border: 1px solid #404040;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .filters-row {
        display: flex;
        gap: 15px;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-size: 12px;
        color: #9ca3af;
        font-weight: 500;
    }

    .filter-group select,
    .filter-group input {
        padding: 8px;
        background-color: #1f1f1f;
        border: 1px solid #404040;
        border-radius: 4px;
        color: #e5e5e5;
        font-size: 14px;
    }

    .filter-group button {
        padding: 8px 16px;
        background-color: #4a90e2;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .filter-group button:hover {
        background-color: #357abd;
    }

    /* Table styling */
    .table-container {
        background-color: #1f1f1f;
        border: 1px solid #404040;
        border-radius: 8px;
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        background-color: #1f1f1f;
        color: #e5e5e5;
    }

    .data-table th {
        background-color: #2a2a2a;
        color: #e5e5e5;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 1px solid #404040;
        font-size: 13px;
    }

    .data-table td {
        padding: 12px;
        border-bottom: 1px solid #333333;
        font-size: 13px;
    }

    .data-table tr:hover {
        background-color: #2a2a2a;
    }

    .data-table tr.clickable {
        cursor: pointer;
    }

    /* Status badges */
    .status-badge {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
        display: inline-block;
    }

    .status-success {
        background-color: #1a4a1a;
        color: #80ff80;
    }

    .status-partial {
        background-color: #4a4a00;
        color: #ffff80;
    }

    .status-failed {
        background-color: #4a1a1a;
        color: #ff8080;
    }

    /* Row highlighting for failed imports */
    .row-failed {
        background-color: rgba(74, 26, 26, 0.3) !important;
    }

    .row-failed:hover {
        background-color: rgba(74, 26, 26, 0.5) !important;
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
    }

    .btn-retry {
        background-color: #4a90e2;
        color: white;
    }

    .btn-retry:hover {
        background-color: #357abd;
    }

    .btn-rollback {
        background-color: #d97706;
        color: white;
    }

    .btn-rollback:hover {
        background-color: #b45309;
    }

    .btn-view {
        background-color: #059669;
        color: white;
    }

    .btn-view:hover {
        background-color: #047857;
    }

    .btn-download {
        background-color: #6366f1;
        color: white;
    }

    .btn-download:hover {
        background-color: #4f46e5;
    }

    /* Expandable row details */
    .details-row {
        display: none;
        background-color: #1a1a1a;
    }

    .details-row.show {
        display: table-row;
    }

    .details-content {
        padding: 20px;
    }

    .details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 15px;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .detail-label {
        font-size: 11px;
        color: #9ca3af;
        text-transform: uppercase;
        font-weight: 600;
    }

    .detail-value {
        font-size: 13px;
        color: #e5e5e5;
    }

    .row-logs-container {
        margin-top: 15px;
        max-height: 400px;
        overflow-y: auto;
        background-color: #0f0f0f;
        border: 1px solid #404040;
        border-radius: 4px;
    }

    .row-log-item {
        padding: 10px;
        border-bottom: 1px solid #2a2a2a;
    }

    .row-log-item:last-child {
        border-bottom: none;
    }

    .row-log-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .row-log-number {
        font-weight: 600;
        color: #9ca3af;
    }

    .row-log-status {
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: bold;
    }

    .row-log-error {
        color: #f87171;
        font-size: 12px;
        margin-top: 5px;
    }

    .row-log-data {
        color: #6b7280;
        font-size: 11px;
        font-family: monospace;
        margin-top: 5px;
        white-space: pre-wrap;
    }

    /* Stats cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: #2a2a2a;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #404040;
    }

    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #e5e5e5;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 12px;
        color: #9ca3af;
    }

    /* Loading and empty states */
    .loading-message,
    .empty-message {
        text-align: center;
        padding: 40px;
        color: #9ca3af;
        font-size: 14px;
    }

    .spinner {
        border: 3px solid #404040;
        border-top: 3px solid #4a90e2;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .details-grid {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Import Execution Logs</h1>
        <div class="header-buttons">
            <button onclick="refreshLogs()" class="btn-action btn-retry">Refresh</button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-row" id="stats-section">
        <!-- Stats will be loaded dynamically -->
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filters-row">
            <div class="filter-group">
                <label for="filter-status">Status</label>
                <select id="filter-status">
                    <option value="">All Statuses</option>
                    <option value="success">Success</option>
                    <option value="partial">Partial</option>
                    <option value="failed">Failed</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filter-account">Account</label>
                <input type="text" id="filter-account" placeholder="Enter account name">
            </div>

            <div class="filter-group">
                <label for="filter-start-date">Start Date</label>
                <input type="date" id="filter-start-date">
            </div>

            <div class="filter-group">
                <label for="filter-end-date">End Date</label>
                <input type="date" id="filter-end-date">
            </div>

            <div class="filter-group">
                <label>&nbsp;</label>
                <button onclick="applyFilters()">Apply Filters</button>
            </div>

            <div class="filter-group">
                <label>&nbsp;</label>
                <button onclick="clearFilters()" style="background-color: #6b7280;">Clear</button>
            </div>
        </div>
    </div>

    <!-- Import Logs Table -->
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Import Time</th>
                    <th>File Name</th>
                    <th>Status</th>
                    <th>Total Rows</th>
                    <th>Success</th>
                    <th>Failed</th>
                    <th>Processing Time</th>
                    <th>Accounts</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="logs-table-body">
                <tr>
                    <td colspan="9">
                        <div class="loading-message">
                            <div class="spinner"></div>
                            Loading import logs...
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentLogs = [];

    // Load logs on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStatistics();
        loadImportLogs();
    });

    // Load statistics
    function loadStatistics() {
        fetch('/api/import-logs/statistics')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayStatistics(data.statistics);
                }
            })
            .catch(error => {
                console.error('Error loading statistics:', error);
            });
    }

    // Display statistics
    function displayStatistics(stats) {
        const statsSection = document.getElementById('stats-section');
        statsSection.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${stats.total_imports}</div>
                <div class="stat-label">Total Imports</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.successful_imports}</div>
                <div class="stat-label">Successful</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.failed_imports}</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.overall_success_rate}%</div>
                <div class="stat-label">Success Rate</div>
            </div>
        `;
    }

    // Load import logs
    function loadImportLogs(filters = {}) {
        const params = new URLSearchParams(filters);

        fetch(`/api/import-logs/list?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentLogs = data.logs;
                    displayImportLogs(data.logs);
                } else {
                    showError('Failed to load import logs');
                }
            })
            .catch(error => {
                console.error('Error loading import logs:', error);
                showError('Error loading import logs');
            });
    }

    // Display import logs
    function displayImportLogs(logs) {
        const tbody = document.getElementById('logs-table-body');

        if (logs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9">
                        <div class="empty-message">No import logs found</div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = logs.map((log, index) => {
            const statusClass = `status-${log.status}`;
            const rowClass = log.status === 'failed' ? 'row-failed' : '';
            const processingTime = log.processing_time_ms ? `${(log.processing_time_ms / 1000).toFixed(2)}s` : 'N/A';
            const accounts = log.affected_accounts ? JSON.parse(log.affected_accounts).join(', ') : 'N/A';

            return `
                <tr class="clickable ${rowClass}" onclick="toggleDetails('${log.import_batch_id}', ${index})">
                    <td>${formatDateTime(log.import_time)}</td>
                    <td>${log.file_name}</td>
                    <td><span class="status-badge ${statusClass}">${log.status}</span></td>
                    <td>${log.total_rows}</td>
                    <td>${log.success_rows}</td>
                    <td>${log.failed_rows}</td>
                    <td>${processingTime}</td>
                    <td>${accounts}</td>
                    <td onclick="event.stopPropagation()">
                        <div class="action-buttons">
                            <button class="btn-action btn-view" onclick="viewDetails('${log.import_batch_id}')">Details</button>
                            <button class="btn-action btn-retry" onclick="retryImport('${log.import_batch_id}')">Retry</button>
                            <button class="btn-action btn-rollback" onclick="rollbackImport('${log.import_batch_id}')">Rollback</button>
                            <button class="btn-action btn-download" onclick="downloadLogs('${log.import_batch_id}')">Download</button>
                        </div>
                    </td>
                </tr>
                <tr class="details-row" id="details-${index}">
                    <td colspan="9">
                        <div class="details-content" id="details-content-${index}">
                            <div class="loading-message">
                                <div class="spinner"></div>
                                Loading details...
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Toggle row details
    function toggleDetails(batchId, index) {
        const detailsRow = document.getElementById(`details-${index}`);
        const isVisible = detailsRow.classList.contains('show');

        // Hide all other details
        document.querySelectorAll('.details-row').forEach(row => {
            row.classList.remove('show');
        });

        if (!isVisible) {
            detailsRow.classList.add('show');
            loadRowDetails(batchId, index);
        }
    }

    // Load row details
    function loadRowDetails(batchId, index) {
        const contentDiv = document.getElementById(`details-content-${index}`);

        fetch(`/api/import-logs/detail/${batchId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayRowDetails(data, contentDiv);
                } else {
                    contentDiv.innerHTML = `<div class="empty-message">Failed to load details</div>`;
                }
            })
            .catch(error => {
                console.error('Error loading row details:', error);
                contentDiv.innerHTML = `<div class="empty-message">Error loading details</div>`;
            });
    }

    // Display row details
    function displayRowDetails(data, container) {
        const log = data.import_log;
        const rowLogs = data.row_logs;

        container.innerHTML = `
            <div class="details-grid">
                <div class="detail-item">
                    <span class="detail-label">File Path</span>
                    <span class="detail-value">${log.file_path}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">File Hash</span>
                    <span class="detail-value">${log.file_hash.substring(0, 16)}...</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Error Summary</span>
                    <span class="detail-value">${log.error_summary || 'None'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Row Count</span>
                    <span class="detail-value">${rowLogs.length} rows logged</span>
                </div>
            </div>

            <h4 style="color: #e5e5e5; margin-bottom: 10px;">Row-Level Logs</h4>
            <div class="row-logs-container">
                ${rowLogs.map(rowLog => `
                    <div class="row-log-item">
                        <div class="row-log-header">
                            <span class="row-log-number">Row ${rowLog.row_number}</span>
                            <span class="row-log-status status-badge status-${rowLog.status}">${rowLog.status}</span>
                        </div>
                        ${rowLog.error_message ? `<div class="row-log-error">${rowLog.error_message}</div>` : ''}
                        ${rowLog.raw_row_data ? `<div class="row-log-data">${formatJSON(rowLog.raw_row_data)}</div>` : ''}
                    </div>
                `).join('')}
            </div>
        `;
    }

    // Format JSON for display
    function formatJSON(jsonStr) {
        try {
            const obj = JSON.parse(jsonStr);
            return JSON.stringify(obj, null, 2);
        } catch {
            return jsonStr;
        }
    }

    // Apply filters
    function applyFilters() {
        const filters = {
            status: document.getElementById('filter-status').value,
            account: document.getElementById('filter-account').value,
            start_date: document.getElementById('filter-start-date').value,
            end_date: document.getElementById('filter-end-date').value
        };

        // Remove empty filters
        Object.keys(filters).forEach(key => {
            if (!filters[key]) delete filters[key];
        });

        loadImportLogs(filters);
    }

    // Clear filters
    function clearFilters() {
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-account').value = '';
        document.getElementById('filter-start-date').value = '';
        document.getElementById('filter-end-date').value = '';
        loadImportLogs();
    }

    // Refresh logs
    function refreshLogs() {
        loadStatistics();
        applyFilters();
    }

    // View details (same as toggle)
    function viewDetails(batchId) {
        const index = currentLogs.findIndex(log => log.import_batch_id === batchId);
        if (index !== -1) {
            toggleDetails(batchId, index);
        }
    }

    // Retry import
    function retryImport(batchId) {
        if (!confirm('Retry this import? The file will be moved back to the import directory for reprocessing.')) {
            return;
        }

        fetch(`/api/import-logs/retry/${batchId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    refreshLogs();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error retrying import:', error);
                alert('Error retrying import');
            });
    }

    // Rollback import
    function rollbackImport(batchId) {
        if (!confirm('WARNING: This will DELETE all trades created by this import. This action cannot be undone. Continue?')) {
            return;
        }

        fetch(`/api/import-logs/rollback/${batchId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    refreshLogs();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error rolling back import:', error);
                alert('Error rolling back import');
            });
    }

    // Download logs
    function downloadLogs(batchId) {
        window.location.href = `/api/import-logs/download/${batchId}`;
    }

    // Format datetime
    function formatDateTime(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString();
    }

    // Show error
    function showError(message) {
        const tbody = document.getElementById('logs-table-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="9">
                    <div class="empty-message" style="color: #f87171;">${message}</div>
                </td>
            </tr>
        `;
    }
</script>
{% endblock %}
