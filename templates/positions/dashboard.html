<!DOCTYPE html>
<html>
<head>
    <title>Trading Positions</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <style>
        .position-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-open { background-color: #fef3c7; color: #92400e; }
        .status-closed { background-color: #d1fae5; color: #065f46; }
        .pnl-positive { color: #059669; font-weight: bold; }
        .pnl-negative { color: #dc2626; font-weight: bold; }
        .pnl-neutral { color: #6b7280; }
        .position-type {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        .type-long { background-color: #dcfce7; color: #166534; }
        .type-short { background-color: #fef2f2; color: #991b1b; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #6b7280;
            font-size: 14px;
        }
        .rebuild-section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header">
        <h1>Trading Positions</h1>
        <div class="header-buttons">
            <a href="{{ url_for('main.index') }}" class="btn">View Trades</a>
            <a href="{{ url_for('statistics.statistics') }}" class="btn stats-btn">Statistics</a>
            <a href="{{ url_for('settings.settings') }}" class="btn settings-btn">Settings</a>
        </div>
    </div>

    <!-- Position Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_positions or 0 }}</div>
            <div class="stat-label">Total Positions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.closed_positions or 0 }}</div>
            <div class="stat-label">Closed Positions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.open_positions or 0 }}</div>
            <div class="stat-label">Open Positions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value {{ 'pnl-positive' if (stats.win_rate or 0) > 50 else 'pnl-negative' }}">
                {{ "%.1f"|format(stats.win_rate or 0) }}%
            </div>
            <div class="stat-label">Win Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-value {{ 'pnl-positive' if (stats.total_pnl or 0) > 0 else 'pnl-negative' }}">
                ${{ "{:,.2f}".format(stats.total_pnl or 0) }}
            </div>
            <div class="stat-label">Total P&L</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ "%.1f"|format(stats.avg_executions_per_position or 0) }}</div>
            <div class="stat-label">Avg Executions/Position</div>
        </div>
    </div>

    <!-- Rebuild Positions Section -->
    <div class="rebuild-section">
        <h3>Position Management</h3>
        <p>Positions are automatically aggregated from your trade executions. Click below to rebuild all positions from existing trade data.</p>
        <button onclick="rebuildPositions()" class="btn" id="rebuildBtn">Rebuild Positions</button>
        <div id="rebuildStatus" style="margin-top: 10px;"></div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <form method="GET" class="filters-form">
            <div class="filter-group">
                <label for="account">Account:</label>
                <select name="account" id="account">
                    <option value="">All Accounts</option>
                    {% for account in accounts %}
                        <option value="{{ account }}" {{ 'selected' if account == selected_account }}>{{ account }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="instrument">Instrument:</label>
                <select name="instrument" id="instrument">
                    <option value="">All Instruments</option>
                    {% for instrument in instruments %}
                        <option value="{{ instrument }}" {{ 'selected' if instrument == selected_instrument }}>{{ instrument }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="status">Status:</label>
                <select name="status" id="status">
                    <option value="">All Positions</option>
                    <option value="open" {{ 'selected' if selected_status == 'open' }}>Open Positions</option>
                    <option value="closed" {{ 'selected' if selected_status == 'closed' }}>Closed Positions</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="sort_by">Sort by:</label>
                <select name="sort_by" id="sort_by">
                    <option value="entry_time" {{ 'selected' if sort_by == 'entry_time' }}>Entry Time</option>
                    <option value="exit_time" {{ 'selected' if sort_by == 'exit_time' }}>Exit Time</option>
                    <option value="total_dollars_pnl" {{ 'selected' if sort_by == 'total_dollars_pnl' }}>P&L</option>
                    <option value="instrument" {{ 'selected' if sort_by == 'instrument' }}>Instrument</option>
                    <option value="account" {{ 'selected' if sort_by == 'account' }}>Account</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="sort_order">Order:</label>
                <select name="sort_order" id="sort_order">
                    <option value="DESC" {{ 'selected' if sort_order == 'DESC' }}>Descending</option>
                    <option value="ASC" {{ 'selected' if sort_order == 'ASC' }}>Ascending</option>
                </select>
            </div>

            <button type="submit" class="btn">Apply Filters</button>
            <a href="{{ url_for('positions.positions_dashboard') }}" class="btn btn-secondary">Clear</a>
        </form>
    </div>

    <!-- Positions Table -->
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Instrument</th>
                    <th>Type</th>
                    <th>Account</th>
                    <th>Entry Time</th>
                    <th>Exit Time</th>
                    <th>Quantity</th>
                    <th>Avg Entry</th>
                    <th>Avg Exit</th>
                    <th>Points P&L</th>
                    <th>Dollar P&L</th>
                    <th>Commission</th>
                    <th>Net P&L</th>
                    <th>Executions</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for position in positions %}
                <tr>
                    <td>
                        <span class="position-status status-{{ position.position_status }}">
                            {{ position.position_status.title() }}
                        </span>
                    </td>
                    <td>{{ position.instrument }}</td>
                    <td>
                        <span class="position-type type-{{ position.position_type.lower() }}">
                            {{ position.position_type }}
                        </span>
                    </td>
                    <td>{{ position.account }}</td>
                    <td>{{ position.entry_time.split(' ')[0] if position.entry_time else 'N/A' }}</td>
                    <td>{{ position.exit_time.split(' ')[0] if position.exit_time else '-' }}</td>
                    <td>{{ position.total_quantity }}</td>
                    <td>${{ "%.2f"|format(position.average_entry_price) }}</td>
                    <td>
                        {% if position.average_exit_price %}
                            ${{ "%.2f"|format(position.average_exit_price) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ "%.2f"|format(position.total_points_pnl or 0) }}</td>
                    <td class="{{ 'pnl-positive' if (position.total_dollars_pnl or 0) > 0 else 'pnl-negative' if (position.total_dollars_pnl or 0) < 0 else 'pnl-neutral' }}">
                        ${{ "{:,.2f}"|format(position.total_dollars_pnl or 0) }}
                    </td>
                    <td>${{ "%.2f"|format(position.total_commission or 0) }}</td>
                    <td class="{{ 'pnl-positive' if ((position.total_dollars_pnl or 0) - (position.total_commission or 0)) > 0 else 'pnl-negative' if ((position.total_dollars_pnl or 0) - (position.total_commission or 0)) < 0 else 'pnl-neutral' }}">
                        ${{ "{:,.2f}"|format((position.total_dollars_pnl or 0) - (position.total_commission or 0)) }}
                    </td>
                    <td>{{ position.execution_count }}</td>
                    <td>
                        <a href="{{ url_for('positions.position_detail', position_id=position.id) }}" class="btn btn-small">View Details</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if current_page > 1 %}
            <a href="{{ url_for('positions.positions_dashboard', page=current_page-1, page_size=page_size, sort_by=sort_by, sort_order=sort_order, account=selected_account, instrument=selected_instrument, status=selected_status) }}" 
               class="btn btn-secondary">Previous</a>
        {% endif %}
        
        <span class="page-info">
            Page {{ current_page }} of {{ total_pages }} ({{ total_count }} positions)
        </span>
        
        {% if current_page < total_pages %}
            <a href="{{ url_for('positions.positions_dashboard', page=current_page+1, page_size=page_size, sort_by=sort_by, sort_order=sort_order, account=selected_account, instrument=selected_instrument, status=selected_status) }}" 
               class="btn btn-secondary">Next</a>
        {% endif %}
    </div>
    {% endif %}

    <script>
        function rebuildPositions() {
            const btn = document.getElementById('rebuildBtn');
            const status = document.getElementById('rebuildStatus');
            
            btn.disabled = true;
            btn.textContent = 'Rebuilding...';
            status.innerHTML = '<div style="color: #6b7280;">Rebuilding positions from trade data...</div>';
            
            fetch('{{ url_for("positions.rebuild_positions") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    status.innerHTML = `<div style="color: #059669;">${data.message}</div>`;
                    // Reload page after 2 seconds to show updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    status.innerHTML = `<div style="color: #dc2626;">Error: ${data.message}</div>`;
                }
            })
            .catch(error => {
                status.innerHTML = `<div style="color: #dc2626;">Error: ${error.message}</div>`;
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'Rebuild Positions';
            });
        }
    </script>
</body>
</html>