{% extends "base.html" %}

{% block title %}Trading Positions{% endblock %}

{% block extra_head %}
<style>
        /* Position-specific styling using CSS variables */
        .page-header {
            background-color: var(--section-bg);
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .position-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-open { background-color: #4a4a00; color: #ffff80; }
        .status-closed { background-color: #1a4a1a; color: #80ff80; }
        .pnl-positive { color: #4ade80; font-weight: bold; }
        .pnl-negative { color: #f87171; font-weight: bold; }
        .pnl-neutral { color: #9ca3af; }
        .position-type {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        .type-long { background-color: #1a4a1a; color: #80ff80; }
        .type-short { background-color: #4a1a1a; color: #ff8080; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #e5e5e5;
        }
        .stat-label {
            color: #9ca3af;
            font-size: 14px;
        }
        .rebuild-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #404040;
        }

        .management-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .action-group {
            background: #1f1f1f;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #404040;
        }

        .action-group h4 {
            margin: 0 0 8px 0;
            color: #e5e5e5;
            font-size: 14px;
        }

        .action-group p {
            margin: 0 0 12px 0;
            color: #9ca3af;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .management-actions {
                grid-template-columns: 1fr;
            }
        }

        /* Header styling */
        .header {
            background-color: #1f1f1f;
            color: #e5e5e5;
            border-bottom: 1px solid #404040;
        }

        /* Table styling */
        .table-container {
            background-color: #1f1f1f;
            border: 1px solid #404040;
            border-radius: 8px;
        }

        .data-table {
            background-color: #1f1f1f;
            color: #e5e5e5;
        }

        .data-table th {
            background-color: #2a2a2a;
            color: #e5e5e5;
            border-bottom: 1px solid #404040;
        }

        .data-table td {
            border-bottom: 1px solid #333333;
        }

        .data-table tr:hover {
            background-color: #333333;
        }

        /* Filters section */
        .filters-section {
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .compact-filters .filters-row {
            display: flex;
            align-items: end;
            gap: 12px;
            flex-wrap: wrap;
        }

        .compact-filters .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 100px;
        }

        /* Validation status styling */
        .validation-healthy {
            color: #4ade80 !important;
        }

        .validation-warning {
            color: #fbbf24 !important;
        }

        .validation-error {
            color: #f87171 !important;
        }

        .validation-loading {
            color: #9ca3af !important;
        }

        #validation-status-card {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #validation-status-card:hover {
            background-color: #3a3a3a;
        }

        .validation-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }

        .validation-modal-content {
            background-color: #2a2a2a;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #555;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: #e5e5e5;
        }

        .validation-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .validation-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .validation-close:hover {
            color: #fff;
        }

        .compact-filters .filter-group label {
            font-size: 11px;
            margin-bottom: 3px;
            color: #9ca3af;
        }

        .compact-filters select {
            background-color: #1f1f1f;
            color: #e5e5e5;
            border: 1px solid #404040;
            padding: 4px 6px;
            font-size: 12px;
            border-radius: 4px;
            min-width: 80px;
        }

        .compact-filters .filter-buttons {
            display: flex;
            gap: 6px;
            margin-top: 14px;
        }

        .btn-compact {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }

        .filters-form select,
        .filters-form input {
            background-color: #1f1f1f;
            color: #e5e5e5;
            border: 1px solid #404040;
        }

        /* Button styling */
        .btn {
            background-color: #404040;
            color: #e5e5e5;
            border: 1px solid #606060;
        }

        .btn:hover {
            background-color: #505050;
        }

        .btn-secondary {
            background-color: #2a2a2a;
            color: #9ca3af;
        }

        .btn-danger {
            background-color: #dc2626;
            color: #ffffff;
            border: 1px solid #b91c1c;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
        }

        .btn-danger:disabled {
            background-color: #4a1a1a;
            color: #6b7280;
            border: 1px solid #374151;
            cursor: not-allowed;
        }

        /* Pagination */
        .pagination {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #404040;
        }

        .page-info {
            color: #9ca3af;
        }

        /* Additional dark mode styling */
        h1, h3 {
            color: #e5e5e5;
        }

        p {
            color: #d1d5db;
        }

        label {
            color: #d1d5db;
        }

        /* Checkbox styling for dark mode */
        input[type="checkbox"] {
            accent-color: #4ade80;
            width: 16px;
            height: 16px;
        }

        .bulk-actions {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #404040;
        }

        /* Validation notification styling */
        .validation-notification {
            background-color: #2a1a1a;
            border-left: 4px solid #f87171;
            padding: 12px 16px;
            margin: 15px 0;
            border-radius: 0 6px 6px 0;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .validation-notification.show {
            display: block;
        }

        .validation-notification.warning {
            background-color: #2a2a1a;
            border-left-color: #fbbf24;
        }

        .validation-notification.success {
            background-color: #1a2a1a;
            border-left-color: #4ade80;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Page Header Section -->
    <div class="page-header">
        <h1>Trading Positions</h1>
        <div class="header-buttons">
            <a href="{{ url_for('main.csv_manager') }}" class="btn">CSV Manager</a>
            <a href="{{ url_for('main.index') }}" class="btn">View Trades</a>
            <a href="{{ url_for('statistics.statistics') }}" class="btn stats-btn">Statistics</a>
            <a href="{{ url_for('settings.settings') }}" class="btn settings-btn">Settings</a>
        </div>
    </div>

    <!-- Validation Notifications -->
    <div id="validation-notification" class="validation-notification">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <strong id="notification-title">Validation Alert</strong>
                <div id="notification-message" style="margin-top: 4px; font-size: 14px;"></div>
            </div>
            <button onclick="hideValidationNotification()" style="background: none; border: none; color: #999; font-size: 18px; cursor: pointer;">&times;</button>
        </div>
    </div>

    <!-- Position Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_positions or 0 }}</div>
            <div class="stat-label">Total Positions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.closed_positions or 0 }}</div>
            <div class="stat-label">Closed Positions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.open_positions or 0 }}</div>
            <div class="stat-label">Open Positions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value {{ 'pnl-positive' if (stats.win_rate or 0) > 50 else 'pnl-negative' }}">
                {{ "%.1f"|format(stats.win_rate or 0) }}%
            </div>
            <div class="stat-label">Win Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-value {{ 'pnl-positive' if (stats.total_pnl or 0) > 0 else 'pnl-negative' }}">
                ${{ "%.2f"|format(stats.total_pnl or 0) }}
            </div>
            <div class="stat-label">Total P&L</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ "%.1f"|format(stats.avg_executions_per_position or 0) }}</div>
            <div class="stat-label">Avg Executions/Position</div>
        </div>
        <div class="stat-card" id="validation-status-card">
            <div class="stat-value" id="validation-status-value">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="stat-label">Position Validation</div>
            <div class="stat-details" id="validation-details" style="font-size: 11px; margin-top: 5px; color: #999;"></div>
        </div>
    </div>

    <!-- Rebuild Positions Section -->
    <!-- Daily Import Scheduler Status -->
    <div id="daily-import-status-card" class="import-status-badge" style="background-color: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
                <span id="import-status-title" style="color: #1e40af; font-weight: 600;">
                    <i class="fas fa-clock"></i> Daily Import Scheduler
                </span>
                <p id="import-status-subtitle" style="margin: 4px 0 0 0; font-size: 0.875rem; color: #4b5563;">
                    Scheduled import at 2:05pm PT • Checking status...
                </p>
                <p id="import-last-import" style="margin: 4px 0 0 0; font-size: 0.75rem; color: #6b7280;">
                </p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="triggerManualImport()" class="btn btn-success" style="white-space: nowrap;">
                    <i class="fas fa-download"></i> Import Now
                </button>
                <a href="{{ url_for('main.csv_manager') }}" class="btn btn-primary" style="white-space: nowrap;">
                    <i class="fas fa-cog"></i> CSV Manager
                </a>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <form method="GET" class="filters-form compact-filters">
            <div class="filters-row">
                <div class="filter-group">
                    <label for="account">Account:</label>
                    <select name="account" id="account">
                        <option value="">All Accounts</option>
                        {% for account in accounts %}
                            <option value="{{ account }}" {{ 'selected' if account == selected_account }}>{{ account }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="instrument">Instrument:</label>
                    <select name="instrument" id="instrument">
                        <option value="">All Instruments</option>
                        {% for instrument in instruments %}
                            <option value="{{ instrument }}" {{ 'selected' if instrument == selected_instrument }}>{{ instrument }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="status">Status:</label>
                    <select name="status" id="status">
                        <option value="">All Positions</option>
                        <option value="open" {{ 'selected' if selected_status == 'open' }}>Open</option>
                        <option value="closed" {{ 'selected' if selected_status == 'closed' }}>Closed</option>
                    </select>
                </div>

                <!-- Task 9.2: Add validation status filter dropdown -->
                <div class="filter-group">
                    <label for="validation_status">Validation:</label>
                    <select name="validation_status" id="validation_status">
                        <option value="">All</option>
                        <option value="valid" {{ 'selected' if selected_validation == 'valid' }}>Valid</option>
                        <option value="invalid" {{ 'selected' if selected_validation == 'invalid' }}>Invalid</option>
                        <option value="mixed" {{ 'selected' if selected_validation == 'mixed' }}>Mixed</option>
                        <option value="null" {{ 'selected' if selected_validation == 'null' or selected_validation == 'unreviewed' }}>Unreviewed</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="sort_by">Sort:</label>
                    <select name="sort_by" id="sort_by">
                        <option value="entry_time" {{ 'selected' if sort_by == 'entry_time' }}>Entry Time</option>
                        <option value="exit_time" {{ 'selected' if sort_by == 'exit_time' }}>Exit Time</option>
                        <option value="total_dollars_pnl" {{ 'selected' if sort_by == 'total_dollars_pnl' }}>P&L</option>
                        <option value="instrument" {{ 'selected' if sort_by == 'instrument' }}>Instrument</option>
                        <option value="account" {{ 'selected' if sort_by == 'account' }}>Account</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="sort_order">Order:</label>
                    <select name="sort_order" id="sort_order">
                        <option value="DESC" {{ 'selected' if sort_order == 'DESC' }}>↓</option>
                        <option value="ASC" {{ 'selected' if sort_order == 'ASC' }}>↑</option>
                    </select>
                </div>

                <div class="filter-buttons">
                    <button type="submit" class="btn btn-compact">Apply</button>
                    <a href="{{ url_for('positions.positions_dashboard') }}" class="btn btn-secondary btn-compact">Clear</a>
                </div>
            </div>
        </form>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions" style="margin-bottom: 15px;">
        <button id="deleteSelectedBtn" class="btn btn-danger" onclick="deleteSelectedPositions()" disabled>
            Delete Selected Positions
        </button>
        <span id="selectedCount" style="margin-left: 10px; color: #9ca3af;">0 positions selected</span>
    </div>

    <!-- Positions Table -->
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th>Status</th>
                    <th>Instrument</th>
                    <th>Type</th>
                    <th>Account</th>
                    <th>Entry Time</th>
                    <th>Exit Time</th>
                    <th>Quantity</th>
                    <th>Avg Entry</th>
                    <th>Avg Exit</th>
                    <th>Points P&L</th>
                    <th>Dollar P&L</th>
                    <th>Commission</th>
                    <th>Net P&L</th>
                    <th>Executions</th>
                    <th>Validation</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for position in positions %}
                <tr>
                    <td><input type="checkbox" class="position-checkbox" value="{{ position.id }}" onchange="updateDeleteButton()"></td>
                    <td>
                        <span class="position-status status-{{ position.position_status }}">
                            {{ position.position_status.title() }}
                        </span>
                    </td>
                    <td>{{ position.instrument }}</td>
                    <td>
                        <span class="position-type type-{{ position.position_type.lower() }}">
                            {{ position.position_type }}
                        </span>
                    </td>
                    <td>{{ position.account }}</td>
                    <td>{{ position.entry_time if position.entry_time else 'N/A' }}</td>
                    <td>{{ position.exit_time if position.exit_time else '-' }}</td>
                    <td>{{ position.max_quantity if position.max_quantity else position.total_quantity }}</td>
                    <td>{{ "%.2f"|format(position.average_entry_price) if position.average_entry_price is not none else "-" }}</td>
                    <td>
                        {% if position.average_exit_price %}
                            {{ "%.2f"|format(position.average_exit_price) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ "%.2f"|format(position.total_points_pnl or 0) if (position.total_points_pnl or 0) is not none else "-" }}</td>
                    <td class="{{ 'pnl-positive' if (position.total_dollars_pnl or 0) > 0 else 'pnl-negative' if (position.total_dollars_pnl or 0) < 0 else 'pnl-neutral' }}">
                        ${{ "%.2f"|format(position.total_dollars_pnl or 0) }}
                    </td>
                    <td>${{ "%.2f"|format(position.total_commission or 0) if (position.total_commission or 0) is not none else "-" }}</td>
                    <td class="{{ 'pnl-positive' if ((position.total_dollars_pnl or 0) - (position.total_commission or 0)) > 0 else 'pnl-negative' if ((position.total_dollars_pnl or 0) - (position.total_commission or 0)) < 0 else 'pnl-neutral' }}">
                        ${{ "%.2f"|format((position.total_dollars_pnl or 0) - (position.total_commission or 0)) }}
                    </td>
                    <td>{{ position.execution_count }}</td>
                    <!-- Task 9.4: Add validation badge to positions table rows -->
                    <td>
                        {% set validation_status = position.validation_status %}
                        {% include 'components/validation_badge.html' %}
                    </td>
                    <td>
                        <a href="{{ url_for('positions.position_detail', position_id=position.id) }}" class="btn btn-small">View Details</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if current_page > 1 %}
            <a href="{{ url_for('positions.positions_dashboard', page=current_page-1, page_size=page_size, sort_by=sort_by, sort_order=sort_order, account=selected_account, instrument=selected_instrument, status=selected_status, validation_status=selected_validation) }}"
               class="btn btn-secondary">Previous</a>
        {% endif %}

        <span class="page-info">
            Page {{ current_page }} of {{ total_pages }} ({{ total_count }} positions)
        </span>

        {% if current_page < total_pages %}
            <a href="{{ url_for('positions.positions_dashboard', page=current_page+1, page_size=page_size, sort_by=sort_by, sort_order=sort_order, account=selected_account, instrument=selected_instrument, status=selected_status, validation_status=selected_validation) }}"
               class="btn btn-secondary">Next</a>
        {% endif %}
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.position-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });

            updateDeleteButton();
        }

        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.position-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');

            const count = checkboxes.length;
            deleteBtn.disabled = count === 0;
            countSpan.textContent = `${count} position${count !== 1 ? 's' : ''} selected`;

            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.position-checkbox');
            const selectAll = document.getElementById('selectAll');
            if (count === 0) {
                selectAll.indeterminate = false;
                selectAll.checked = false;
            } else if (count === allCheckboxes.length) {
                selectAll.indeterminate = false;
                selectAll.checked = true;
            } else {
                selectAll.indeterminate = true;
                selectAll.checked = false;
            }
        }

        function deleteSelectedPositions() {
            const checkboxes = document.querySelectorAll('.position-checkbox:checked');
            const positionIds = Array.from(checkboxes).map(cb => cb.value);

            if (positionIds.length === 0) {
                alert('No positions selected for deletion.');
                return;
            }

            const confirmation = confirm(`Are you sure you want to delete ${positionIds.length} position${positionIds.length !== 1 ? 's' : ''}? This action cannot be undone.`);

            if (!confirmation) {
                return;
            }

            const deleteBtn = document.getElementById('deleteSelectedBtn');
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Deleting...';

            fetch('{{ url_for("positions.delete_positions") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    position_ids: positionIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Successfully deleted ${data.deleted_count} position${data.deleted_count !== 1 ? 's' : ''}.`);
                    window.location.reload();
                } else {
                    alert(`Error deleting positions: ${data.message}`);
                }
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
            })
            .finally(() => {
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Delete Selected Positions';
            });
        }

        // Validation Status Management
        class ValidationStatusManager {
            constructor() {
                this.statusCard = document.getElementById('validation-status-card');
                this.statusValue = document.getElementById('validation-status-value');
                this.statusDetails = document.getElementById('validation-details');
                this.modal = null;
                this.init();
            }

            init() {
                this.createModal();
                this.loadValidationStatus();
                this.statusCard.addEventListener('click', () => this.showValidationDetails());

                // Refresh validation status every 60 seconds
                setInterval(() => this.loadValidationStatus(), 60000);
            }

            createModal() {
                this.modal = document.createElement('div');
                this.modal.className = 'validation-modal';
                this.modal.innerHTML = `
                    <div class="validation-modal-content">
                        <div class="validation-modal-header">
                            <h2>Position Validation Details</h2>
                            <span class="validation-close">&times;</span>
                        </div>
                        <div id="validation-modal-body">
                            <div style="text-align: center; color: #999;">
                                <i class="fas fa-spinner fa-spin"></i> Loading validation details...
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(this.modal);

                // Close modal handlers
                this.modal.querySelector('.validation-close').addEventListener('click', () => this.hideModal());
                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) this.hideModal();
                });
            }

            async loadValidationStatus() {
                try {
                    const response = await fetch('/api/validation/summary');
                    const data = await response.json();

                    if (data.success) {
                        this.updateStatusDisplay(data.summary);
                    } else {
                        this.showError('Failed to load validation status');
                    }
                } catch (error) {
                    this.showError('Connection error');
                    console.error('Validation status error:', error);
                }
            }

            updateStatusDisplay(summary) {
                const hasIssues = summary.has_issues;
                const overlaps = summary.overlaps_found || 0;
                const violations = summary.boundary_violations || 0;

                // Check if status changed from previous check
                const previousStatus = this.lastStatus;
                this.lastStatus = { hasIssues, overlaps, violations };

                // Update status icon and color
                if (!hasIssues) {
                    this.statusValue.innerHTML = '<i class="fas fa-check-circle"></i>';
                    this.statusValue.className = 'stat-value validation-healthy';
                    this.statusDetails.textContent = 'All positions valid';

                    // Show success notification if issues were resolved
                    if (previousStatus && previousStatus.hasIssues && !hasIssues) {
                        this.showNotification('Issues Resolved', 'All position validation issues have been resolved.', 'success');
                    }
                } else if (overlaps > 0 || violations > 0) {
                    this.statusValue.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                    this.statusValue.className = 'stat-value validation-error';
                    this.statusDetails.textContent = `${overlaps + violations} issues found`;

                    // Show error notification if new issues detected
                    if (!previousStatus || (!previousStatus.hasIssues && hasIssues)) {
                        this.showNotification('Validation Issues Detected',
                            `Found ${overlaps} overlaps and ${violations} boundary violations. Click the validation card for details.`, 'error');
                    }
                } else {
                    this.statusValue.innerHTML = '<i class="fas fa-info-circle"></i>';
                    this.statusValue.className = 'stat-value validation-warning';
                    this.statusDetails.textContent = 'Minor warnings';
                }

                // Update tooltip
                this.statusCard.title = `Click for details - Last checked: ${new Date().toLocaleTimeString()}`;
            }

            showNotification(title, message, type = 'error') {
                const notification = document.getElementById('validation-notification');
                const titleEl = document.getElementById('notification-title');
                const messageEl = document.getElementById('notification-message');

                titleEl.textContent = title;
                messageEl.textContent = message;

                // Reset classes
                notification.className = 'validation-notification';

                // Add appropriate class
                if (type === 'warning') {
                    notification.classList.add('warning');
                } else if (type === 'success') {
                    notification.classList.add('success');
                }

                // Show notification
                notification.classList.add('show');

                // Auto-hide after 10 seconds
                setTimeout(() => {
                    if (notification.classList.contains('show')) {
                        notification.classList.remove('show');
                    }
                }, 10000);
            }

            showError(message) {
                this.statusValue.innerHTML = '<i class="fas fa-times-circle"></i>';
                this.statusValue.className = 'stat-value validation-error';
                this.statusDetails.textContent = message;
            }

            async showValidationDetails() {
                this.modal.style.display = 'block';
                const modalBody = document.getElementById('validation-modal-body');

                // Show loading
                modalBody.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Loading detailed validation report...
                    </div>
                `;

                try {
                    // Load detailed validation data
                    const [summaryRes, analysisRes] = await Promise.all([
                        fetch('/api/validation/summary'),
                        fetch('/api/validation/current-positions')
                    ]);

                    const summaryData = await summaryRes.json();
                    const analysisData = await analysisRes.json();

                    if (summaryData.success && analysisData.success) {
                        this.renderValidationDetails(summaryData, analysisData);
                    } else {
                        modalBody.innerHTML = '<div style="color: #f87171;">Error loading validation details</div>';
                    }
                } catch (error) {
                    modalBody.innerHTML = '<div style="color: #f87171;">Connection error loading details</div>';
                    console.error('Validation details error:', error);
                }
            }

            renderValidationDetails(summaryData, analysisData) {
                const summary = summaryData.summary;
                const analysis = analysisData.analysis;
                const modalBody = document.getElementById('validation-modal-body');

                const statusIcon = summary.has_issues ?
                    '<i class="fas fa-exclamation-triangle" style="color: #f87171;"></i>' :
                    '<i class="fas fa-check-circle" style="color: #4ade80;"></i>';

                modalBody.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3>${statusIcon} Validation Summary</h3>
                        <div style="background: #1f1f1f; padding: 15px; border-radius: 6px; margin: 10px 0;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div>
                                    <div style="color: #999; font-size: 12px;">Total Positions</div>
                                    <div style="font-size: 18px; font-weight: bold;">${summary.total_positions || 0}</div>
                                </div>
                                <div>
                                    <div style="color: #999; font-size: 12px;">Groups Analyzed</div>
                                    <div style="font-size: 18px; font-weight: bold;">${summary.groups_analyzed || 0}</div>
                                </div>
                                <div>
                                    <div style="color: #999; font-size: 12px;">Overlaps Found</div>
                                    <div style="font-size: 18px; font-weight: bold; color: ${summary.overlaps_found > 0 ? '#f87171' : '#4ade80'};">${summary.overlaps_found || 0}</div>
                                </div>
                                <div>
                                    <div style="color: #999; font-size: 12px;">Boundary Violations</div>
                                    <div style="font-size: 18px; font-weight: bold; color: ${summary.boundary_violations > 0 ? '#f87171' : '#4ade80'};">${summary.boundary_violations || 0}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${summary.has_issues ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #f87171;">Issues Detected</h4>
                            <div style="background: #2a1a1a; border-left: 4px solid #f87171; padding: 15px; border-radius: 0 6px 6px 0;">
                                Position overlaps or boundary violations detected. Consider running position rebuild with validation to address these issues.
                            </div>
                        </div>
                    ` : `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #4ade80;">All Clear</h4>
                            <div style="background: #1a2a1a; border-left: 4px solid #4ade80; padding: 15px; border-radius: 0 6px 6px 0;">
                                No position overlaps or boundary violations detected. Your position data is healthy.
                            </div>
                        </div>
                    `}

                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="validationManager.triggerRebuild()" class="btn" style="margin-right: 10px;">
                            <i class="fas fa-sync"></i> Rebuild with Validation
                        </button>
                        <button onclick="validationManager.refreshValidation()" class="btn">
                            <i class="fas fa-refresh"></i> Refresh Status
                        </button>
                    </div>

                    <div style="margin-top: 15px; text-align: center; color: #999; font-size: 12px;">
                        Last checked: ${new Date(summary.validation_timestamp).toLocaleString()}
                    </div>
                `;
            }

            hideModal() {
                this.modal.style.display = 'none';
            }

            async triggerRebuild() {
                if (confirm('Rebuild all positions with validation? This may take a few moments.')) {
                    this.hideModal();
                    rebuildPositions(); // Use existing rebuild function
                }
            }

            async refreshValidation() {
                this.hideModal();
                this.loadValidationStatus();
            }
        }

        // Global function to hide validation notifications
        function hideValidationNotification() {
            const notification = document.getElementById('validation-notification');
            notification.classList.remove('show');
        }

        // Initialize validation status manager when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.validationManager = new ValidationStatusManager();
            loadDailyImportStatus();
            // Refresh status every 60 seconds
            setInterval(loadDailyImportStatus, 60000);
        });

        // ================================================================
        // Daily Import Scheduler Functions
        // ================================================================

        async function loadDailyImportStatus() {
            try {
                const response = await fetch('/api/csv/daily-import/status');
                const data = await response.json();

                if (data.success) {
                    updateDailyImportUI(data);
                } else {
                    console.error('Failed to load daily import status:', data.error);
                    updateDailyImportUI({
                        running: false,
                        scheduled_import_time: '2:05 PT',
                        next_scheduled_import: 'Unknown',
                        last_scheduled_import: null,
                        last_manual_import: null
                    });
                }
            } catch (error) {
                console.error('Error loading daily import status:', error);
            }
        }

        function updateDailyImportUI(status) {
            const statusCard = document.getElementById('daily-import-status-card');
            const statusTitle = document.getElementById('import-status-title');
            const statusSubtitle = document.getElementById('import-status-subtitle');
            const lastImportText = document.getElementById('import-last-import');

            // Update status indicator
            if (status.running) {
                statusCard.style.backgroundColor = '#d1fae5';
                statusCard.style.borderColor = '#10b981';
                statusTitle.innerHTML = '<i class="fas fa-check-circle"></i> Daily Import Scheduler Active';
                statusTitle.style.color = '#065f46';
            } else {
                statusCard.style.backgroundColor = '#fef3c7';
                statusCard.style.borderColor = '#f59e0b';
                statusTitle.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Daily Import Scheduler Inactive';
                statusTitle.style.color = '#92400e';
            }

            // Update subtitle with next import time
            const nextImport = status.next_scheduled_import || 'Not scheduled';
            statusSubtitle.textContent = `Scheduled at ${status.scheduled_import_time} • Next: ${nextImport}`;
            statusSubtitle.style.color = status.running ? '#047857' : '#92400e';

            // Update last import info
            let lastImportInfo = '';
            if (status.last_manual_import) {
                const lastManual = new Date(status.last_manual_import);
                lastImportInfo = `Last manual import: ${lastManual.toLocaleString()}`;
            } else if (status.last_scheduled_import) {
                const lastScheduled = new Date(status.last_scheduled_import);
                lastImportInfo = `Last scheduled import: ${lastScheduled.toLocaleString()}`;
            } else {
                lastImportInfo = 'No imports yet today';
            }
            lastImportText.textContent = lastImportInfo;
        }

        async function triggerManualImport() {
            // Confirm action
            if (!confirm('Import today\'s CSV file now? This will process all new executions and rebuild positions for affected accounts.')) {
                return;
            }

            const importButton = event.target;
            const originalText = importButton.innerHTML;

            // Disable button and show loading state
            importButton.disabled = true;
            importButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';

            try {
                const response = await fetch('/api/csv/daily-import/manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.success) {
                    // Show success message
                    alert(`✓ Import successful!\n\nExecutions imported: ${data.total_executions}\nPositions rebuilt: ${data.positions_rebuilt}\nAccounts affected: ${data.accounts_affected ? data.accounts_affected.join(', ') : 'None'}`);

                    // Reload the page to show updated positions
                    window.location.reload();
                } else {
                    // Show error message
                    alert(`✗ Import failed:\n\n${data.error}`);
                }
            } catch (error) {
                console.error('Error triggering manual import:', error);
                alert(`Error triggering manual import: ${error.message}`);
            } finally {
                // Re-enable button
                importButton.disabled = false;
                importButton.innerHTML = originalText;

                // Refresh status
                loadDailyImportStatus();
            }
        }
</script>
{% endblock %}
