<!-- Position Custom Fields Component - Auto-Save -->
<div class="position-custom-fields" id="positionCustomFields-{{ position.id }}">
    <div class="custom-fields-header mb-3">
        <h3>Custom Fields</h3>
    </div>

    <!-- Loading State -->
    <div id="customFieldsLoading-{{ position.id }}" class="text-center py-3">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Loading custom fields...</span>
        </div>
        <small class="text-muted ms-2">Loading custom fields...</small>
    </div>

    <!-- Empty State -->
    <div id="customFieldsEmpty-{{ position.id }}" class="text-center py-4" style="display: none;">
        <div class="text-muted">
            <i class="fas fa-clipboard fa-2x mb-2" style="opacity: 0.3;"></i>
            <p class="mb-2">No custom fields configured</p>
            <small>Add custom fields in <a href="{{ url_for('settings.settings') }}#custom-fields" class="text-decoration-none">Settings</a> to track additional data.</small>
        </div>
    </div>

    <!-- Inline Editable Custom Fields (Auto-Save) -->
    <div id="customFieldsForm-{{ position.id }}" style="display: none;">
        <div class="row" id="customFieldsGrid-{{ position.id }}">
            <!-- Fields will be populated here -->
        </div>
    </div>
</div>


<style>
/* Position Custom Fields Styling */
.position-custom-fields {
    background: #2a2a2a;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    border: 1px solid #404040;
    margin-bottom: 30px;
}

.custom-fields-display .custom-field-item {
    background: #1f1f1f;
    padding: 15px;
    border-radius: 6px;
    border: 1px solid #404040;
    margin-bottom: 15px;
}

.custom-field-label {
    font-size: 12px;
    color: #9ca3af;
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 5px;
}

.custom-field-value {
    font-size: 14px;
    color: #e5e5e5;
    font-weight: 500;
}

.custom-field-value.empty {
    color: #9ca3af;
    font-style: italic;
}

.custom-field-value.boolean-true {
    color: #4ade80;
}

.custom-field-value.boolean-false {
    color: #f87171;
}

.custom-field-value.number {
    font-family: monospace;
    color: #fbbf24;
}

.custom-field-value.date {
    color: #8b5cf6;
}

.custom-field-description {
    font-size: 11px;
    color: #6b7280;
    margin-top: 3px;
}

/* Form styling in modal */
.custom-field-form-group {
    background: #2a2a2a;
    padding: 15px;
    border-radius: 6px;
    border: 1px solid #404040;
    margin-bottom: 15px;
}

.custom-field-form-label {
    font-weight: 600;
    color: #e5e5e5;
    margin-bottom: 5px;
}

.custom-field-required-indicator {
    color: #ef4444;
}

/* Custom form controls for dark theme */
.form-control.dark-theme,
.form-select.dark-theme {
    background-color: #1f1f1f;
    border-color: #404040;
    color: #e5e5e5;
}

.form-control.dark-theme:focus,
.form-select.dark-theme:focus {
    background-color: #1f1f1f;
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    color: #e5e5e5;
}

.form-control.dark-theme::placeholder {
    color: #9ca3af;
}

.form-check-input.dark-theme {
    background-color: #1f1f1f;
    border-color: #404040;
}

.form-check-input.dark-theme:checked {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

.form-check-input.dark-theme:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
}

.form-check-label {
    color: #e5e5e5;
}

/* Auto-save indicator styling */
.save-indicator {
    background-color: transparent;
    border: none;
    padding: 0 8px;
    align-items: center;
}

.input-group .save-indicator {
    background-color: #1f1f1f;
    border: 1px solid #404040;
    border-left: none;
}

.save-indicator i {
    font-size: 14px;
}

/* Responsive grid for custom fields display */
@media (min-width: 768px) {
    .custom-fields-display .row > .col-md-6:nth-child(2n+1) {
        clear: left;
    }
}

@media (min-width: 992px) {
    .custom-fields-display .row > .col-lg-4:nth-child(3n+1) {
        clear: left;
    }
    .custom-fields-display .row > .col-md-6:nth-child(2n+1) {
        clear: none;
    }
}
</style>

<script>
// Position Custom Fields JavaScript - Auto-Save on Change
class PositionCustomFields {
    constructor() {
        this.apiBaseUrl = '/api/custom-fields';
        this.fieldsData = {};
        this.fieldValues = {};
        this.saveTimeouts = {};  // Debounce text input saves
    }

    async loadPositionFields(positionId) {
        const loadingElement = document.getElementById(`customFieldsLoading-${positionId}`);
        const emptyElement = document.getElementById(`customFieldsEmpty-${positionId}`);
        const formElement = document.getElementById(`customFieldsForm-${positionId}`);

        try {
            loadingElement.style.display = 'block';
            emptyElement.style.display = 'none';
            formElement.style.display = 'none';

            const [fieldsResponse, valuesResponse] = await Promise.all([
                fetch(`${this.apiBaseUrl}/`, { headers: { 'Accept': 'application/json' } }),
                fetch(`${this.apiBaseUrl}/positions/${positionId}/values`, { headers: { 'Accept': 'application/json' } })
            ]);

            const fieldsData = await fieldsResponse.json();
            const valuesData = await valuesResponse.json();

            if (fieldsData.success) {
                const activeFields = fieldsData.data.filter(field => field.is_active);

                if (activeFields.length === 0) {
                    emptyElement.style.display = 'block';
                } else {
                    this.fieldsData[positionId] = activeFields;
                    this.fieldValues[positionId] = valuesData.success ? valuesData.data : [];
                    this.displayInlineFields(positionId, activeFields, this.fieldValues[positionId]);
                    formElement.style.display = 'block';
                }
            } else {
                console.error('Failed to load custom fields:', fieldsData.message);
                emptyElement.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading position custom fields:', error);
            emptyElement.style.display = 'block';
        } finally {
            loadingElement.style.display = 'none';
        }
    }

    displayInlineFields(positionId, fields, values) {
        const gridElement = document.getElementById(`customFieldsGrid-${positionId}`);
        if (!gridElement) return;

        gridElement.innerHTML = '';

        const valueMap = {};
        values.forEach(value => {
            valueMap[value.custom_field_id] = value.field_value;
        });

        fields.forEach(field => {
            const fieldValue = valueMap[field.id] || field.default_value || '';
            const fieldElement = this.createInlineFieldElement(positionId, field, fieldValue);
            gridElement.appendChild(fieldElement);
        });
    }

    createInlineFieldElement(positionId, field, value) {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 mb-3';
        const fieldId = `field_${positionId}_${field.id}`;

        let inputHtml = '';

        switch (field.field_type) {
            case 'text':
                inputHtml = `
                    <div class="input-group">
                        <input type="text" class="form-control dark-theme" id="${fieldId}" data-field-id="${field.id}"
                               value="${this.escapeHtml(value)}" placeholder="Enter ${this.escapeHtml(field.label).toLowerCase()}..."
                               ${field.is_required ? 'required' : ''}>
                        <span class="input-group-text save-indicator" id="${fieldId}_status" style="display: none;">
                            <i class="fas fa-check text-success"></i>
                        </span>
                    </div>`;
                break;

            case 'number':
                inputHtml = `
                    <div class="input-group">
                        <input type="number" class="form-control dark-theme" id="${fieldId}" data-field-id="${field.id}"
                               value="${this.escapeHtml(value)}" step="any" placeholder="0" ${field.is_required ? 'required' : ''}>
                        <span class="input-group-text save-indicator" id="${fieldId}_status" style="display: none;">
                            <i class="fas fa-check text-success"></i>
                        </span>
                    </div>`;
                break;

            case 'date':
                const dateValue = value ? new Date(value).toISOString().split('T')[0] : '';
                inputHtml = `
                    <div class="input-group">
                        <input type="date" class="form-control dark-theme" id="${fieldId}" data-field-id="${field.id}"
                               value="${dateValue}" ${field.is_required ? 'required' : ''}>
                        <span class="input-group-text save-indicator" id="${fieldId}_status" style="display: none;">
                            <i class="fas fa-check text-success"></i>
                        </span>
                    </div>`;
                break;

            case 'boolean':
                const checked = value && value.toLowerCase() === 'true' ? 'checked' : '';
                inputHtml = `
                    <div class="d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input dark-theme" id="${fieldId}" data-field-id="${field.id}"
                                   value="true" ${checked}>
                            <label class="form-check-label" for="${fieldId}" id="${fieldId}_label">${checked ? 'Yes' : 'No'}</label>
                        </div>
                        <span class="save-indicator ms-2" id="${fieldId}_status" style="display: none;">
                            <i class="fas fa-check text-success"></i>
                        </span>
                    </div>`;
                break;

            case 'select':
                let options = '<option value="">Select...</option>';
                let fieldOptions = field.options || [];
                if (field.validation_rules) {
                    try {
                        const rules = typeof field.validation_rules === 'string'
                            ? JSON.parse(field.validation_rules)
                            : field.validation_rules;
                        if (rules.options && Array.isArray(rules.options)) {
                            fieldOptions = rules.options.map(opt => ({
                                option_value: opt,
                                option_label: opt
                            }));
                        }
                    } catch (e) {
                        console.warn('Could not parse validation_rules:', e);
                    }
                }
                fieldOptions.forEach(option => {
                    const optValue = option.option_value || option;
                    const optLabel = option.option_label || option;
                    const selected = value === optValue ? 'selected' : '';
                    options += `<option value="${this.escapeHtml(optValue)}" ${selected}>${this.escapeHtml(optLabel)}</option>`;
                });
                inputHtml = `
                    <div class="input-group">
                        <select class="form-select dark-theme" id="${fieldId}" data-field-id="${field.id}"
                                ${field.is_required ? 'required' : ''}>${options}</select>
                        <span class="input-group-text save-indicator" id="${fieldId}_status" style="display: none;">
                            <i class="fas fa-check text-success"></i>
                        </span>
                    </div>`;
                break;
        }

        col.innerHTML = `
            <div class="custom-field-form-group">
                <label class="custom-field-form-label" for="${fieldId}">
                    ${this.escapeHtml(field.label)}
                    ${field.is_required ? '<span class="custom-field-required-indicator">*</span>' : ''}
                </label>
                ${inputHtml}
                ${field.description ? `<small class="form-text text-muted">${this.escapeHtml(field.description)}</small>` : ''}
            </div>
        `;

        // Attach auto-save event listeners after element is added to DOM
        setTimeout(() => {
            const input = col.querySelector(`#${fieldId}`);
            if (!input) return;

            if (field.field_type === 'boolean') {
                // Checkbox: save immediately on change
                input.addEventListener('change', () => {
                    const label = col.querySelector(`#${fieldId}_label`);
                    if (label) label.textContent = input.checked ? 'Yes' : 'No';
                    this.autoSaveField(positionId, field.id, input.checked ? 'true' : 'false', fieldId);
                });
            } else if (field.field_type === 'select' || field.field_type === 'date') {
                // Select/Date: save immediately on change
                input.addEventListener('change', () => {
                    this.autoSaveField(positionId, field.id, input.value, fieldId);
                });
            } else {
                // Text/Number: debounce save (wait 500ms after typing stops)
                input.addEventListener('input', () => {
                    this.debounceSaveField(positionId, field.id, input.value, fieldId);
                });
                // Also save on blur (when user leaves the field)
                input.addEventListener('blur', () => {
                    if (this.saveTimeouts[fieldId]) {
                        clearTimeout(this.saveTimeouts[fieldId]);
                        delete this.saveTimeouts[fieldId];
                    }
                    this.autoSaveField(positionId, field.id, input.value, fieldId);
                });
            }
        }, 0);

        return col;
    }

    debounceSaveField(positionId, fieldId, value, inputId) {
        // Clear existing timeout for this field
        if (this.saveTimeouts[inputId]) {
            clearTimeout(this.saveTimeouts[inputId]);
        }
        // Set new timeout to save after 500ms of inactivity
        this.saveTimeouts[inputId] = setTimeout(() => {
            this.autoSaveField(positionId, fieldId, value, inputId);
            delete this.saveTimeouts[inputId];
        }, 500);
    }

    async autoSaveField(positionId, fieldId, value, inputId) {
        const statusElement = document.getElementById(`${inputId}_status`);

        try {
            // Show saving indicator
            if (statusElement) {
                statusElement.innerHTML = '<i class="fas fa-spinner fa-spin text-muted"></i>';
                statusElement.style.display = 'flex';
            }

            const success = await this.saveFieldValue(positionId, fieldId, value);

            if (statusElement) {
                if (success) {
                    statusElement.innerHTML = '<i class="fas fa-check text-success"></i>';
                } else {
                    statusElement.innerHTML = '<i class="fas fa-times text-danger"></i>';
                }
                // Hide after 2 seconds
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 2000);
            }
        } catch (error) {
            console.error('Auto-save error:', error);
            if (statusElement) {
                statusElement.innerHTML = '<i class="fas fa-times text-danger"></i>';
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 2000);
            }
        }
    }

    async saveFieldValue(positionId, fieldId, value) {
        try {
            const response = await fetch(`${this.apiBaseUrl}/positions/${positionId}/values`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    custom_field_id: fieldId,
                    field_value: value
                })
            });

            const data = await response.json();
            return data.success;
        } catch (error) {
            console.error(`Error saving field ${fieldId}:`, error);
            return false;
        }
    }

    escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }
}

// Initialize and auto-load
const positionCustomFields = new PositionCustomFields();

document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('[id^="positionCustomFields-"]');
    if (container) {
        const positionId = container.id.split('-')[1];
        positionCustomFields.loadPositionFields(parseInt(positionId));
    }
});
</script>