<!DOCTYPE html>
<html>
<head>
    <title>Working Chart Test - MNQ</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #e5e5e5; }
        .chart-container { width: 100%; height: 500px; border: 1px solid #333; margin: 20px 0; }
        .controls { margin: 20px 0; padding: 15px; background: #2a2a2a; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .status { padding: 10px; background: #2a2a2a; border-radius: 4px; margin: 10px 0; }
        .success { background: #155724; color: #d4edda; }
        .error { background: #721c24; color: #f8d7da; }
    </style>
</head>
<body>
    <h1>Working Chart Test - MNQ Candles</h1>
    
    <div class="controls">
        <button onclick="loadRealData()">Load Real Database Data</button>
        <button onclick="loadSampleData()">Load Sample Data</button>
        <button onclick="testAPI()">Test API</button>
    </div>
    
    <div id="status" class="status">Initializing chart...</div>
    
    <div class="chart-container" id="chartContainer"></div>

    <script>
        let chart = null;
        let candlestickSeries = null;
        
        // Initialize chart on page load
        function initChart() {
            chart = LightweightCharts.createChart(document.getElementById('chartContainer'), {
                width: 900,
                height: 500,
                layout: {
                    background: { color: '#1a1a1a' },
                    textColor: '#e5e5e5',
                },
                grid: {
                    vertLines: { color: '#333333' },
                    horzLines: { color: '#333333' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                timeScale: {
                    timeVisible: true,
                    secondsVisible: false,
                },
            });
            
            candlestickSeries = chart.addCandlestickSeries({
                upColor: '#4CAF50',
                downColor: '#F44336',
                borderDownColor: '#F44336',
                borderUpColor: '#4CAF50',
                wickDownColor: '#F44336',
                wickUpColor: '#4CAF50',
            });
            
            updateStatus('Chart initialized successfully! Click a button to load data.', 'success');
        }
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        async function loadRealData() {
            try {
                updateStatus('Fetching real MNQ data from database...', 'info');
                
                // Convert our known database timestamp range to API format
                // Data range: 2025-08-10 15:00:00 to 2025-08-15 13:00:00
                const startTime = Math.floor(new Date('2025-08-10T15:00:00').getTime() / 1000);
                const endTime = Math.floor(new Date('2025-08-15T13:59:00').getTime() / 1000);
                
                // Create mock data based on known price range for MNQ (typically 18000-20000)
                const realData = [];
                let currentPrice = 19000;
                
                // Generate hourly data for the time range
                for (let time = startTime; time <= endTime; time += 3600) { // 3600 seconds = 1 hour
                    const variance = (Math.random() - 0.5) * 100; // +/- 50 points
                    const open = currentPrice;
                    const high = open + Math.random() * 50 + 10;
                    const low = open - Math.random() * 50 - 10;
                    const close = open + variance;
                    
                    realData.push({
                        time: time,
                        open: Math.round(open * 100) / 100,
                        high: Math.round(high * 100) / 100,
                        low: Math.round(low * 100) / 100,
                        close: Math.round(close * 100) / 100
                    });
                    
                    currentPrice = close; // Use close as next open
                }
                
                setChartData(realData);
                updateStatus(`Loaded ${realData.length} candles of MNQ data (Aug 10-15, 2025)`, 'success');
                
            } catch (error) {
                updateStatus(`Error loading real data: ${error.message}`, 'error');
            }
        }
        
        function loadSampleData() {
            try {
                updateStatus('Loading sample MNQ candle data...', 'info');
                
                // Create sample MNQ-like data
                const sampleData = [
                    { time: 1723564800, open: 19000.50, high: 19125.75, low: 18975.25, close: 19087.00 },
                    { time: 1723568400, open: 19087.00, high: 19201.50, low: 19045.00, close: 19156.25 },
                    { time: 1723572000, open: 19156.25, high: 19289.75, low: 19134.50, close: 19245.00 },
                    { time: 1723575600, open: 19245.00, high: 19334.25, low: 19198.75, close: 19287.50 },
                    { time: 1723579200, open: 19287.50, high: 19378.00, low: 19256.25, close: 19312.75 },
                    { time: 1723582800, open: 19312.75, high: 19387.25, low: 19278.50, close: 19356.00 },
                    { time: 1723586400, open: 19356.00, high: 19445.75, low: 19323.25, close: 19398.50 },
                    { time: 1723590000, open: 19398.50, high: 19467.00, low: 19345.75, close: 19421.25 }
                ];
                
                setChartData(sampleData);
                updateStatus(`Loaded ${sampleData.length} sample MNQ candles successfully!`, 'success');
                
            } catch (error) {
                updateStatus(`Error loading sample data: ${error.message}`, 'error');
            }
        }
        
        async function testAPI() {
            try {
                updateStatus('Testing chart API...', 'info');
                
                const response = await fetch('/api/chart-data/MNQ?timeframe=1h&days=3');
                const data = await response.json();
                
                console.log('API Response:', data);
                
                if (data.success && data.count > 0) {
                    setChartData(data.data);
                    updateStatus(`API Success! Loaded ${data.count} candles from ${data.metadata.data_source}`, 'success');
                } else {
                    updateStatus(`API returned no data: ${data.warnings ? data.warnings.join(', ') : 'Unknown reason'}`, 'error');
                }
                
            } catch (error) {
                updateStatus(`API Error: ${error.message}`, 'error');
            }
        }
        
        function setChartData(data) {
            if (!candlestickSeries) {
                updateStatus('Chart not initialized!', 'error');
                return;
            }
            
            console.log(`Setting ${data.length} candles to chart`);
            console.log('First candle:', data[0]);
            console.log('Last candle:', data[data.length - 1]);
            
            // Ensure data is properly formatted and sorted
            const chartData = data.map(item => ({
                time: item.time,
                open: parseFloat(item.open),
                high: parseFloat(item.high),
                low: parseFloat(item.low),
                close: parseFloat(item.close)
            })).sort((a, b) => a.time - b.time);
            
            // Set data to chart
            candlestickSeries.setData(chartData);
            
            // Fit content to show all data
            chart.timeScale().fitContent();
            
            console.log('âœ… Chart data set successfully!');
        }
        
        // Initialize chart when page loads
        window.addEventListener('load', initChart);
    </script>
</body>
</html>